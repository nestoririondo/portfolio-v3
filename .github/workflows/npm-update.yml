name: Weekly NPM Updates

on:
  # Run every Monday at 9 AM UTC (10 AM CET)
  schedule:
    - cron: '0 9 * * 1'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        persist-credentials: true
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
    - name: Install current dependencies
      run: npm ci
      
    - name: Check for outdated packages
      id: outdated
      run: |
        echo "Checking for outdated packages..."
        
        # Run npm outdated and capture both stdout and stderr
        npm outdated > outdated.txt 2>&1 || true
        
        echo "Output from npm outdated:"
        cat outdated.txt
        
        # Count actual package lines (skip any header/error messages)
        if [ -s outdated.txt ]; then
          # Look for lines that contain package names with version numbers
          OUTDATED_COUNT=$(grep -E "^[a-zA-Z@].*[0-9].*[0-9].*[0-9]" outdated.txt | wc -l | tr -d ' ' || echo "0")
        else
          OUTDATED_COUNT=0
        fi
        
        echo "Calculated outdated count: $OUTDATED_COUNT"
        echo "outdated_count=$OUTDATED_COUNT" >> "$GITHUB_OUTPUT"
        echo "ðŸ“¦ Found $OUTDATED_COUNT outdated packages"
        
        # Clean up
        rm -f outdated.txt
        
    - name: Update dependencies
      if: steps.outdated.outputs.outdated_count > 0
      run: |
        echo "ðŸ”„ Updating npm dependencies..."
        
        # Update all dependencies
        npm update
        
        # Also update devDependencies
        npm update --save-dev
        
        # Audit and fix vulnerabilities
        npm audit fix || true
        
        echo "âœ… Dependencies updated"
        
    - name: Run tests after update
      if: steps.outdated.outputs.outdated_count > 0
      env:
        CONTENTFUL_SPACE_ID: ${{ secrets.CONTENTFUL_SPACE_ID }}
        CONTENTFUL_ACCESS_TOKEN: ${{ secrets.CONTENTFUL_ACCESS_TOKEN }}
        CONTENTFUL_PREVIEW_ACCESS_TOKEN: ${{ secrets.CONTENTFUL_PREVIEW_ACCESS_TOKEN }}
        PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
        POSTHOG_KEY: ${{ secrets.POSTHOG_KEY }}
        POSTHOG_HOST: ${{ secrets.POSTHOG_HOST }}
      run: |
        # Run build to ensure everything still works
        npm run build || {
          echo "âŒ Build failed after dependency update"
          exit 1
        }
        
        # Run linting if available
        if npm run lint --silent > /dev/null 2>&1; then
          npm run lint || {
            echo "âš ï¸ Linting failed after dependency update"
            exit 1
          }
        fi
        
    - name: Check for changes
      id: changes
      if: steps.outdated.outputs.outdated_count > 0
      run: |
        # Check if package-lock.json was modified
        if git diff --quiet package-lock.json; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ No changes to commit"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Changes detected in package-lock.json"
        fi
        
    - name: Generate update summary
      if: steps.changes.outputs.has_changes == 'true'
      id: summary
      run: |
        # Generate a summary of updated packages
        echo "ðŸ“¦ **NPM Dependencies Updated**" > update_summary.md
        echo "" >> update_summary.md
        echo "**Date**: $(date '+%Y-%m-%d %H:%M UTC')" >> update_summary.md
        echo "" >> update_summary.md
        
        # Get the changes from git diff
        echo "**Updated Packages**:" >> update_summary.md
        git diff package-lock.json | grep '"version":' | head -20 | while read line; do
          echo "- $line" >> update_summary.md
        done
        
        # Add security audit info
        echo "" >> update_summary.md
        echo "**Security Audit**:" >> update_summary.md
        npm audit --audit-level moderate >> update_summary.md || echo "No security issues found" >> update_summary.md
        
        # Read summary for commit message
        SUMMARY=$(head -50 update_summary.md | tr '\n' ' ')
        echo "update_summary=$SUMMARY" >> $GITHUB_OUTPUT
        
    - name: Create Pull Request
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        # Create a new branch for the update
        BRANCH_NAME="npm-updates-$(date '+%Y%m%d-%H%M%S')"
        git checkout -b "$BRANCH_NAME"
        
        # Add updated files
        git add package-lock.json
        
        # Create commit with detailed message
        git commit -m "ðŸ”„ Weekly NPM dependency updates

        - Updated npm dependencies to latest versions
        - Resolved security vulnerabilities
        - Build and tests passing after updates
        - Date: $(date '+%Y-%m-%d %H:%M UTC')
        
        ðŸ¤– Automated weekly maintenance
        
        Co-authored-by: GitHub Actions <actions@github.com>"
        
        # Push the branch
        git push origin "$BRANCH_NAME"
        
        # Try to create PR with PAT if available, otherwise provide manual link
        if [[ -n "${{ secrets.PAT_TOKEN }}" ]]; then
          # Create and auto-merge PR using PAT
          PR_URL=$(gh pr create \
            --title "ðŸ”„ Weekly NPM dependency updates - $(date '+%Y-%m-%d')" \
            --body "## ðŸ“¦ Automated NPM Dependency Updates

          This PR contains automated weekly updates to npm dependencies.

          **Date**: $(date '+%Y-%m-%d %H:%M UTC')
          **Updated Packages**: See package-lock.json changes
          **Build Status**: âœ… Passed
          **Security Audit**: âœ… No vulnerabilities found

          ### Changes
          - Updated npm dependencies to latest versions
          - Resolved any security vulnerabilities
          - Build and tests passing after updates

          This is an automated update created by GitHub Actions.

          ðŸ¤– Generated by [Weekly NPM Updates Workflow](https://github.com/${{ github.repository }}/actions/workflows/npm-update.yml)" \
            --head "$BRANCH_NAME" \
            --base main)
          
          echo "âœ… Pull request created: $PR_URL"
          
          # Enable auto-merge if available
          gh pr merge "$PR_URL" --auto --squash || echo "Auto-merge not available, PR created for manual review"
          
          # Add to workflow summary
          echo "## âœ… NPM Update PR Created" >> $GITHUB_STEP_SUMMARY
          echo "Pull request created and set to auto-merge: $PR_URL" >> $GITHUB_STEP_SUMMARY
        else
          # Fallback to manual PR creation
          echo "âœ… Branch created successfully: $BRANCH_NAME"
          echo "ðŸ“ Create pull request manually at:"
          echo "https://github.com/${{ github.repository }}/compare/main...$BRANCH_NAME"
          
          # Add to workflow summary
          echo "## âœ… NPM Update Branch Created" >> $GITHUB_STEP_SUMMARY
          echo "Branch \`$BRANCH_NAME\` has been created with dependency updates." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. [Create Pull Request](https://github.com/${{ github.repository }}/compare/main...$BRANCH_NAME)" >> $GITHUB_STEP_SUMMARY
          echo "2. Review the dependency changes" >> $GITHUB_STEP_SUMMARY
          echo "3. Merge when ready" >> $GITHUB_STEP_SUMMARY
        fi
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        
    - name: Create workflow summary
      run: |
        echo "## ðŸ“¦ NPM Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Date**: $(date '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Outdated Packages**: ${{ steps.outdated.outputs.outdated_count }}" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ steps.changes.outputs.has_changes }}" == "true" ]]; then
          echo "- **Status**: âœ… Dependencies updated and branch created" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Status**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ steps.outdated.outputs.outdated_count }}" == "0" ]]; then
          echo "- **Status**: âœ… All dependencies are up to date" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Status**: â„¹ï¸ No changes needed" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Add security info
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”’ Security Status" >> $GITHUB_STEP_SUMMARY
        npm audit --audit-level moderate >> $GITHUB_STEP_SUMMARY || echo "No security vulnerabilities found" >> $GITHUB_STEP_SUMMARY
        
    - name: Notify on failure
      if: failure()
      run: |
        echo "## âŒ NPM Update Failed" >> $GITHUB_STEP_SUMMARY
        echo "- **Date**: $(date '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **Error**: Dependency update or build failed" >> $GITHUB_STEP_SUMMARY
        echo "- **Action Required**: Manual intervention needed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Please check the workflow logs and update dependencies manually." >> $GITHUB_STEP_SUMMARY