name: Automated Blog Generation

on:
  # Scheduled posts - Tuesday 9 AM and Friday 2 PM CET (Berlin time)
  schedule:
    - cron: '0 7 * * 2'  # Tuesday 9 AM CET (7 AM UTC)
    - cron: '0 12 * * 5' # Friday 2 PM CET (12 PM UTC)
  
  # Manual trigger for on-demand posts
  workflow_dispatch:
    inputs:
      force_topic:
        description: 'Force a specific topic (optional)'
        required: false
        type: string
      use_trending:
        description: 'Use trending topics detection'
        required: false
        default: true
        type: boolean

jobs:
  generate-blog-post:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
        
    - name: Generate blog post
      env:
        CONTENTFUL_SPACE_ID: ${{ secrets.CONTENTFUL_SPACE_ID }}
        CONTENTFUL_ACCESS_TOKEN: ${{ secrets.CONTENTFUL_ACCESS_TOKEN }}
        CONTENTFUL_MANAGEMENT_TOKEN: ${{ secrets.CONTENTFUL_MANAGEMENT_TOKEN }}
        CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
        UNSPLASH_SECRET_KEY: ${{ secrets.UNSPLASH_SECRET_KEY }}
        FORCE_TOPIC: ${{ inputs.force_topic }}
        USE_TRENDING: ${{ inputs.use_trending }}
      run: node scripts/auto-trending-blog.js
      
    - name: Create summary
      run: |
        echo "## 📝 Blog Generation Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Date**: $(date '+%Y-%m-%d (%A)')" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        if [[ -n "${{ inputs.force_topic }}" ]]; then
          echo "- **Forced Topic**: ${{ inputs.force_topic }}" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- **Use Trending**: ${{ inputs.use_trending }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ✅ Blog post generated and published to Contentful" >> $GITHUB_STEP_SUMMARY